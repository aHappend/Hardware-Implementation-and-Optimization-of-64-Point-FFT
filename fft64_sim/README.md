# FFT64 Simulation & Verification

## Project Highlights
- 64-point radix-2 DIT FFT (SDF architecture), including twiddle factor ROM, complex multiplier, input bit-reversal buffer, and cascaded delay lines.
- A unified Q1.15 fixed-point interface is adopted across RTL, testbench, and Python verification scripts, with internal computations retaining extra bit width before quantization.
- Five stimulus modes (Pulse/Sine/Square/Random/File Input) are fully aligned between SystemVerilog and Python, facilitating point-by-point comparison.
- `run_fft64_all.py` enables one-click execution of Vivado batch simulation, NumPy verification, and archives Vivado logs by timestamp.
- `py/check_fft64.py` prints maximum/average errors, lists point-by-point comparisons, and saves overlay plots of amplitude and phase.

## Repository Structure
```
fft64_sim/
├─ sim/                    # SystemVerilog RTL and testbench. The actual files used are `sim/fft64_model.sv` and `sim/tb_fft64.sv`; 
                           # others are source codes for fully parallel and folded versions, which can be used as replacements
├─ py/                     # Python verification and plotting scripts
├─ scripts/                # Vivado batch TCL scripts
├─ vivado_project/         # Vivado project and XSim artifacts (FFT64_SIM.xpr is located here)
├─ rt1/                    # Optional external stimulus (input.txt)
├─ plots/ / plots_example/ # Generated plots / Example plots
├─ logs/                   # Runtime logs (archived by timestamp)
├─ run_fft64_all.py        # One-click driver script
└─ README.md               # Documentation (English + Chinese)
```

## Core Source Files
- `sim/fft64_model.sv`: FFT data path, including all stage control and multiply-accumulate logic.
- `sim/tb_fft64.sv`: Self-driven testbench that outputs `output_vivado.txt`.
- `scripts/run_sim.tcl`: Vivado XSim batch script.
- `py/check_fft64.py`: NumPy reference implementation + plotting functions.
- `rt1/input.txt`: 64 lines of fixed-point samples read when input mode is set to FILE.

## Architecture Overview
A frame of 64-point data sequentially passes through 6 DIT SDF stages (with delay length of `1 << stage_id`). Twiddle factors are provided by ROM, and the complex multiplier outputs the add/subtract results of butterflies. Normalization is consistent with Python: $Y[k] = \frac{1}{64} \sum_{n=0}^{63} x[n] e^{-j 2 \pi k n / 64}$.

## Simulation Flow
1. **Stimulus Preparation**: `tb_fft64.sv` generates 64-point input based on `INPUT_MODE`, with default amplitude of `2^(DATA_WIDTH-3)`.
2. **Vivado Execution**: Run `vivado -mode batch -source scripts/run_sim.tcl` (or the Python wrapper script) to generate `output_vivado.txt`.
3. **Python Verification**: `py/check_fft64.py` constructs input with the same mode, runs `numpy.fft.fft(x)/64`, prints errors and generates plots.
4. **Log Archiving**: `run_fft64_all.py` moves new `vivado.log/jou/backup` to `logs/vivado_run_timestamp/` and optionally copies XSim logs.

## Input Modes (Shared by SV and Python)
| ID | Mode      | Description |
|----|-----------|-------------|
| 0  | PULSE     | Only `x[0]=AMP`, others are 0 (for impulse response testing) |
| 1  | SINE      | Single-frequency sine wave, with frequency index determined by `WAVE_K` |
| 2  | SQUARE    | Square wave derived from sign quantization of sine wave |
| 3  | RANDOM    | Complex sequence generated by LCG, fully synchronized between SV and Python |
| 4  | FROM_FILE | Reads 64 lines of `real imag` from `rt1/input.txt` |

Ensure `INPUT_MODE` is consistent between `sim/tb_fft64.sv` and `py/check_fft64.py` (or override via `--input-mode` in command line).

## Usage
### Environment Requirements
- Vivado 2018.3 (modify `VIVADO_EXE` in `run_fft64_all.py` if the installation path is different).
- Python 3.8+, with `numpy` and `matplotlib` installed.

### One-Click Run (Vivado + Python)
```
python run_fft64_all.py
```

### Run Vivado Only
```
vivado -mode batch -source scripts/run_sim.tcl
```

### Run Python Verification Only
```
python py/check_fft64.py --input-mode 1 --no-show --save-dir plots
```

## Outputs & Logs
- FFT Results: `output_vivado.txt` (64 lines of `real imag` in Q1.15 format).
- Plots: `py/check_fft64.py` saves amplitude/phase plots in `plots/` by default.
- Vivado Logs: `run_fft64_all.py` generates a folder `vivado_run_Date_Time/` under `logs/`.

## Key Points of Python Verification Script
- Shares stimulus generator, bit width and amplitude settings with the testbench.
- Built-in fixed-point/floating-point conversion functions for easy debugging.
- Prints maximum/average absolute errors and point-by-point differences, and provides `threshold_complex()` to clean up near-zero noise.

## Common Issues
- **Vivado executable not found**: Verify the installation path and update `VIVADO_EXE`.
- **Missing `output_vivado.txt`**: Ensure simulation completes successfully and the path is correct.
- **Phase plot with excessive spurs**: Phase of frequency bins with near-zero amplitude diverges and can be ignored or filtered via the threshold function.
- **Custom stimulus**: Write 64 lines of `real imag` to `rt1/input.txt` and set `INPUT_MODE=4`.

# FFT64 Simulation & Verification

## 项目亮点
- 64 点 radix-2 DIT FFT（SDF 结构），含旋转因子 ROM、复乘器、输入位反转缓冲以及级联延迟线。
- RTL、testbench 与 Python 校验脚本统一使用 Q1.15 定点接口，内部计算保留额外位宽后再量化。
- 五种激励模式（脉冲/正弦/方波/随机/文件输入）在 SystemVerilog 与 Python 之间完全对齐，便于逐点比对。
- `run_fft64_all.py` 一键完成 Vivado 批处理仿真、NumPy 校验，并按时间戳归档 Vivado 日志。
- `py/check_fft64.py` 打印最大/平均误差、列出逐点对比，并保存幅度/相位叠加图。

## 仓库结构
```
fft64_sim/
├─ sim/                    # SystemVerilog RTL 与 testbench，实际使用的是`sim/fft64_model.sv`和`sim/tb_fft64.sv`，其余为全并行和折叠版的原码，可用来替换使用
├─ py/                     # Python 校验与绘图脚本
├─ scripts/                # Vivado 批处理 TCL
├─ vivado_project/         # Vivado 工程与 XSim 产物，FFT64_SIM.xpr也在此处
├─ rt1/                    # 可选外部激励 (input.txt)
├─ plots/ / plots_example/ # 已生成 / 示例图
├─ logs/                   # 运行日志（按时间戳归档）
├─ run_fft64_all.py        # 一键驱动脚本
└─ README.md               # 说明，本文件（含英文 + 中文）
```

## 核心源码
- `sim/fft64_model.sv`：FFT 数据通路，包含所有阶段控制与乘加逻辑。
- `sim/tb_fft64.sv`：自驱动 testbench，输出 `output_vivado.txt`。
- `scripts/run_sim.tcl`：Vivado XSim 批处理脚本。
- `py/check_fft64.py`：NumPy 参考实现 + 绘图。
- `rt1/input.txt`：当输入模式设为 FILE 时读取的 64 行定点样本。

## 架构概述
一帧 64 点数据依次穿过 6 个 DIT SDF 级（延迟长度为 `1 << stage_id`）。旋转因子由 ROM 提供，复乘单元输出蝶形的加/减结果。归一化与 Python 保持一致：$Y[k] = \frac{1}{64} \sum_{n=0}^{63} x[n] e^{-j 2 \pi k n / 64}$。

## 仿真流程
1. **激励准备**：`tb_fft64.sv` 根据 `INPUT_MODE` 生成 64 点输入，默认幅度 `2^(DATA_WIDTH-3)`。
2. **Vivado 运行**：执行 `vivado -mode batch -source scripts/run_sim.tcl`（或 Python 封装脚本），生成 `output_vivado.txt`。
3. **Python 校验**：`py/check_fft64.py` 用相同模式构造输入，运行 `numpy.fft.fft(x)/64`，打印误差并绘图。
4. **日志归档**：`run_fft64_all.py` 将新的 `vivado.log/jou/backup` 移动至 `logs/vivado_run_时间戳/`，并可选复制 XSim 日志。

## 输入模式（SV 与 Python 共享）
| ID | 模式      | 说明 |
|----|-----------|------|
| 0  | PULSE     | 仅 `x[0]=AMP`，其余为 0，用于冲激响应 |
| 1  | SINE      | 单频正弦，频率索引由 `WAVE_K` 决定 |
| 2  | SQUARE    | 正弦符号化得到的方波 |
| 3  | RANDOM    | LCG 生成的复数序列，SV/Python 完全同步 |
| 4  | FROM_FILE | 读取 `rt1/input.txt` 的 64 行 `real imag` |

请保持 `sim/tb_fft64.sv` 与 `py/check_fft64.py` 中的 `INPUT_MODE` 一致（或在命令行通过 `--input-mode` 覆盖）。

## 使用方法
**环境要求**
- Vivado 2018.3（若安装路径不同，请修改 `run_fft64_all.py` 中的 `VIVADO_EXE`）。
- Python 3.8+，并安装 `numpy`、`matplotlib`。

**一键运行 Vivado + Python**
```
python run_fft64_all.py
```

**单独运行 Vivado**
```
vivado -mode batch -source scripts/run_sim.tcl
```

**单独运行 Python 校验**
```
python py/check_fft64.py --input-mode 1 --no-show --save-dir plots
```

## 输出与日志
- FFT 结果：`output_vivado.txt`（64 行 `real imag`，Q1.15）。
- 绘图：`py/check_fft64.py` 默认在 `plots/` 下保存幅度/相位图。
- Vivado 日志：`run_fft64_all.py` 会在 `logs/` 下生成 `vivado_run_日期_时间/` 文件夹。

## Python 校验脚本要点
- 与 testbench 共享激励发生器、位宽与幅度设置。
- 内置定点/浮点互转函数，便于调试。
- 打印最大/平均绝对误差、逐点差值，并提供 `threshold_complex()` 清理接近零的噪声。

## 常见问题
- **Vivado 可执行文件不存在**：确认安装路径，更新 `VIVADO_EXE`。
- **缺少 `output_vivado.txt`**：确保仿真已成功完成或路径正确。
- **相位图杂散较多**：幅度接近零的频点相位会发散，可忽略或启用阈值函数。
- **自定义激励**：把 64 行 `real imag` 写入 `rt1/input.txt` 并设定 `INPUT_MODE=4`。
